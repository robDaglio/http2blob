# HTTP2Blob

## Description
The HTTP2Blob service exposes a single HTTP endpoint **/blob** that accepts flat (single-level) JSON
payloads. Once a payload is received, the application will asynchronously forward the payload
to an **Azure Blob Storage** container using Microsoft's
[azure.storage.blob.aio](https://learn.microsoft.com/en-us/python/api/azure-storage-blob/azure.storage.blob.aio?view=azure-python) module.

## Dependencies
The service is intended to run as a microservice, hosted within Azure infrastructure, the
most practical of which is within an
[Azure Container Application](https://azure.microsoft.com/en-us/products/container-apps/),
 but can also be run locally as either a python script or docker container.

### Microservice Dependencies
* Docker 20.10.17 or later
* Access to KB private docker registry or Docker hub

## Configuration
Before deploying the service to the cloud, two important parameters must be defined
either within the **defaults.ini** file, or passed as environment variables when running
the container:

**connection-string**: the connection string for the target blob storage account generated by
Azure.

**container-name**: the name of the target Azure storage blob container

**api-user**: username to authenticate against when posting a payload.

**api-pass**: the password for the specified api username.


**Defaults.ini:**
```
[default]
log-level=INFO
log-file=app.log
listening-port=8084
connection-string=DefaultEndpointsProtocol=https;AccountName=<account_name>;AccountKey=<hash_value>;EndpointSuffix=core.windows.net
container-name=<container_name>
api-user=<username>
api-pass=<password>
```

### Running the Service
Log into the **docker.mysck.net** docker registry:
```
docker login -u <username> -p <password> docker.mysck.net
```

Optionally pull the image from the registry:
```
docker pull docker.mysck.net/snapshot/iot/kb-adx-endpoint
```

To run the service locally, use the docker run command to create and run the container:
```
docker run \
	-v /etc/timezone:/etc/timezone \
	-v /etc/localtime:/etc/localtime \
	-v /var/log/kb/adx-endpoint:/usr/src/app/logs \
	-p 8084:8084 \
	-e LOG_LEVEL=DEBUG \
	--name http2blob \
	--restart=always \
	-d docker.mysck.net/snapshot/iot/http2blob
```

## Endpoints
The service exposes two endpoints:

```
GET /echo/ -> endpoint returns success message to verify service is running
POST /blob/ -> the endpoint to push JSON payloads to for forwarding to Azure blob storage
```

To view more detailed information for each endpoint, navigate to **http://<service_url>:8084/docs** while the 
service is running.

## Making a Request
When posting to **/blob**, all **JSON** payloads must be single-row type objects that do not
include any nested complex data-types such as lists or dictionaries.


**Example payload:**
```
{
    "EventID": "108003349",
    "DateTime": "2022-10-31 01:43:32",
    "Location": "Miami",
    "Stage": "ORDER TAKEN",
    "Product": "Poppers" 
}
```

**Example REST call:**
```
curl -sSL -X POST \
-u 'user_name':'password' \
--header 'Content-Type: application/json' \
-d '{
    "EventID": 108003382,
    "DateTime": "2022-12-7 10:14:32",
    "Location": "Miami",
    "Stage": "PAYMENT",
    "Product": "Banana Bread"
}' 'http://127.0.0.1:8084/blob' 
```

**Example response:**

A successful request will result in a **client request ID**. 

```
2328645a-700f-11ed-9245-00155d2f4291
```

The JSON payload can contain any number of single-row key/value pairs. Ingestion mapping is currently configured only
for strings, but other simple data types can also be passed.

## Verifying Results
To view the pushed data, log into Azure and find the target storage group resource within
the appropriate resource group. The blob should be visible within the **storage browser**.
